<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>最火后台管理系统 RuoYi 项目探秘，之二 | 阿呜的边城-Awu&#39;s World</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/favicon/favicon.ico">
    <meta name="description" content="分享一切与开发编程以及开发者相关的文章。微信公众号：程序员爱读书">
    <meta name="keywords" content="开发者,程序员,程序猿,程序媛,极客,码农,编程,代码,软件开发,开源,IT网站,技术社区,Developer,Programmer,Coder,Geek,Coding,Code,阿呜的边程,阿呜的编程">
    <link rel="preload" href="/assets/css/0.styles.4630dd33.css" as="style"><link rel="preload" href="/assets/js/app.467e2829.js" as="script"><link rel="preload" href="/assets/js/7.4e539d82.js" as="script"><link rel="preload" href="/assets/js/58.69071d3d.js" as="script"><link rel="prefetch" href="/assets/js/1.7e906b04.js"><link rel="prefetch" href="/assets/js/10.e0248698.js"><link rel="prefetch" href="/assets/js/12.e538132d.js"><link rel="prefetch" href="/assets/js/13.2a2f676b.js"><link rel="prefetch" href="/assets/js/14.214a405f.js"><link rel="prefetch" href="/assets/js/15.f38aa5fe.js"><link rel="prefetch" href="/assets/js/16.f1929af0.js"><link rel="prefetch" href="/assets/js/17.07d76279.js"><link rel="prefetch" href="/assets/js/18.d6db1d2b.js"><link rel="prefetch" href="/assets/js/19.84710e5e.js"><link rel="prefetch" href="/assets/js/2.7ac2fab1.js"><link rel="prefetch" href="/assets/js/20.f959fe80.js"><link rel="prefetch" href="/assets/js/21.2fd86fda.js"><link rel="prefetch" href="/assets/js/22.c77ef176.js"><link rel="prefetch" href="/assets/js/23.8a8ffe22.js"><link rel="prefetch" href="/assets/js/24.b6c2e323.js"><link rel="prefetch" href="/assets/js/25.6fd04512.js"><link rel="prefetch" href="/assets/js/26.2974a93c.js"><link rel="prefetch" href="/assets/js/27.7a62c283.js"><link rel="prefetch" href="/assets/js/28.f8974e73.js"><link rel="prefetch" href="/assets/js/29.cb3e8910.js"><link rel="prefetch" href="/assets/js/3.9254d7f5.js"><link rel="prefetch" href="/assets/js/30.bf6a36b7.js"><link rel="prefetch" href="/assets/js/31.5dec5686.js"><link rel="prefetch" href="/assets/js/32.8a42b4c0.js"><link rel="prefetch" href="/assets/js/33.83abd616.js"><link rel="prefetch" href="/assets/js/34.ee89ddca.js"><link rel="prefetch" href="/assets/js/35.23327e0c.js"><link rel="prefetch" href="/assets/js/36.d1398816.js"><link rel="prefetch" href="/assets/js/37.831600d9.js"><link rel="prefetch" href="/assets/js/38.71dccc31.js"><link rel="prefetch" href="/assets/js/39.9368b3e2.js"><link rel="prefetch" href="/assets/js/4.1a846bb9.js"><link rel="prefetch" href="/assets/js/40.96d1de0d.js"><link rel="prefetch" href="/assets/js/41.4bc03f21.js"><link rel="prefetch" href="/assets/js/42.c6c92807.js"><link rel="prefetch" href="/assets/js/43.89080e02.js"><link rel="prefetch" href="/assets/js/44.66cfb85b.js"><link rel="prefetch" href="/assets/js/45.a7e3d8ae.js"><link rel="prefetch" href="/assets/js/46.9d784267.js"><link rel="prefetch" href="/assets/js/47.88a828fd.js"><link rel="prefetch" href="/assets/js/48.a62bea2b.js"><link rel="prefetch" href="/assets/js/49.ea543004.js"><link rel="prefetch" href="/assets/js/5.96353e26.js"><link rel="prefetch" href="/assets/js/50.eba5af66.js"><link rel="prefetch" href="/assets/js/51.d274e43f.js"><link rel="prefetch" href="/assets/js/52.4443a52d.js"><link rel="prefetch" href="/assets/js/53.4112b49f.js"><link rel="prefetch" href="/assets/js/54.98363e68.js"><link rel="prefetch" href="/assets/js/55.87360021.js"><link rel="prefetch" href="/assets/js/56.e8482afd.js"><link rel="prefetch" href="/assets/js/57.d4ee3fcd.js"><link rel="prefetch" href="/assets/js/59.67f1a597.js"><link rel="prefetch" href="/assets/js/6.8c198353.js"><link rel="prefetch" href="/assets/js/60.c40c582e.js"><link rel="prefetch" href="/assets/js/61.f1757ef1.js"><link rel="prefetch" href="/assets/js/62.13c89e9c.js"><link rel="prefetch" href="/assets/js/63.6ad00547.js"><link rel="prefetch" href="/assets/js/64.a2915c89.js"><link rel="prefetch" href="/assets/js/65.f3caf203.js"><link rel="prefetch" href="/assets/js/66.5f72902f.js"><link rel="prefetch" href="/assets/js/67.c5106e01.js"><link rel="prefetch" href="/assets/js/68.c0662345.js"><link rel="prefetch" href="/assets/js/69.67072028.js"><link rel="prefetch" href="/assets/js/70.19b64377.js"><link rel="prefetch" href="/assets/js/71.f52a0e24.js"><link rel="prefetch" href="/assets/js/8.b31a6a19.js"><link rel="prefetch" href="/assets/js/9.e4ce902a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4630dd33.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/assets/img/cloud.jpg);" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          阿呜的边城-Awu's World
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            程序员爱读书
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            文章列表
          </a><a href="https://github.com/dev2007" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>GitHub</span> <span data-v-e4145d0a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://micronaut.bookhub.tech" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>Micronaut</span> <span data-v-e4145d0a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          最火后台管理系统 RuoYi 项目探秘，之二
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      发布时间 : 2022-10-28
    </span> <!----></section> <section class="post-links" data-v-4e23451f><a href="/posts/2022/10/19/ruoyi-1.html" class="post-link" data-v-4e23451f>
      上一篇 : 最火后台管理系统 RuoYi 项目探秘，之一
    </a> <a href="/posts/2022/11/12/ruoyi-3.html" class="post-link" data-v-4e23451f>
      下一篇 : 最火后台管理系统 RuoYi 项目探秘，之三
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><p>上篇中，我们初步观察了 RuoYi 的项目结构，并在最后实际运行起了项目。我们也发现了作者不好的代码习惯，作为反例，我们应该要养成良好的编码习惯。本篇开始，我们会按照 Web 界面逐一对具体子项目的实现的功能进行探秘。
</p> <h2 id="常见又不常见的登录"><a href="#常见又不常见的登录" class="header-anchor">#</a> 常见又不常见的登录</h2> <p>在上一篇中，我们知道两个很重要的信息，一是 RuoYi 项目没有使用前后端分离，用的是 Thymeleaf 模板；二是权限框架选用的 Shiro。</p> <p>没有前后端分离，说明登录以及其他业务的 API 响应，必定有一部分是针对 html 的响应，而非全部是 Restful API，落在具体的登录功能上，说明登录表单提交数据的 API，有可能响应的就直接一个 html 页面了。</p> <p>而 Shiro 框架，说明我们对相关 RBAC 代码分析时，需要从 Shiro 框架的特点进行。</p> <p>我们再次运行项目，并访问 <code>http://localhost</code>，进入登录界面后，按 F12 打开浏览器的开发人员工具，然后输入验证码，点击登录。接着我们观察工具的中的网络中的 XHR，然后发现调用了登录 API：<code>http://localhost/login</code>，如图：</p> <p><img src="/assets/img/ruoyi/2/1.jpg" alt="login"></p> <p>我们再看请求体，如图：</p> <p><img src="/assets/img/ruoyi/2/2.jpg" alt="body"></p> <p>这里存在一个非常严重的问题！！密码明文传输，安全性很差！！如果我们要用 RuoYi 或者自己搭框架来做一些安全评级较高的项目，比如等保项目，很可能由于这个密码问题就直接被否定了。</p> <p>解决方法：密码加密后传输，加密算法选用非对称的，如 RSA。进一步，传输协议调整为 https，顺便还对防止重放攻击。</p> <p>另外，我们还发现这里传输了验证码，那验证码如何与当前登录绑定的？我们先验证一下是否可以进行验证码替换攻击。</p> <p>我们在浏览器同时打开两个登录界面，两个登录界面分别有两个验证码，如图：</p> <p><img src="/assets/img/ruoyi/2/4.jpg" alt="code"></p> <p><img src="/assets/img/ruoyi/2/5.jpg" alt="code"></p> <p>我们将第二个验证码答案填入第一个界面，看能否登录。直接登录成功了。说明验证码与当前登录操作可能只有会话绑定关系，只要是同一会话，就认为是同一个操作。我们再用两个不同的浏览器验证一下，这次就无法替换验证码登录了，说明验证码确实是只与会话绑定，后面我们再从代码中确认一次。</p> <p>然后我们看一下登录成功后的前端逻辑，如图：</p> <p><img src="/assets/img/ruoyi/2/3.jpg" alt="login success"></p> <p>可以看到 <code>/login</code> 接口响应 <code>200</code> 后，前端进入首页 <code>index</code>，说明前端是判定登录响应为 <code>200</code> 后，再次访问 <code>index</code>，由于后台会话已记录登录状态，所以鉴权通过，访问返回首页的 html 内容。</p> <p>为了解答验证码的问题以及更深入了解 RuoYi 项目的登录实现，我们进入代码进行探秘。</p> <h2 id="神秘的验证码"><a href="#神秘的验证码" class="header-anchor">#</a> 神秘的验证码</h2> <p>上面，我们已经知道登录入口 API 为 <code>/login</code>，那么只要找到该 API ，就可以找到入口深入 RuoYi。</p> <p>Sping Boot 项目的话，推荐一个 IDEA 插件 <code>RestfulToolkit</code>，它可以很方便的搜索 API，要是没有工具的话，我们就只能用全局搜索法，来找我们想看的 API。</p> <p>我们先找 <code>/login</code> API，如图：</p> <p><img src="/assets/img/ruoyi/2/6.jpg" alt="login"></p> <p>同时，我们也顺便展开的 RuoYi 的包结构，如图：</p> <p><img src="/assets/img/ruoyi/2/7.jpg" alt="package"></p> <p>真的是辣眼睛。</p> <p><img src="/assets/img/ruoyi/2/8.jpg" alt="package"></p> <p>一般工程实践中，我们会尽量用业务去划分包的结构，即同业务的在一个包里，更细的划分在用子包体现。而不会像 RuoYi 这样将一大堆可能业务相近的 Controller 扔同一个包里就完了，区分度再用类名去区分。这样其实很让人头疼。</p> <p>我们继续分析 <code>/login</code>。</p> <p>首先，我们看到这个 Controller 有比较多的 JavaDoc 注释和代码注释，这个很好，能够方便别人理解代码。但是 API 所对应的 Controller 函数却没有注释，直接懵逼，算了，我们接着分析代码。</p> <p><code>GET /login</code> 所对应的函数参数有三个： <code>HttpServletRequest request</code>、<code>HttpServletResponse response</code> 和 <code>ModelMap mmap</code>，这个 <code>mmap</code> 是个啥玩意？我们点进他的定义 <code>ModelMap</code> 里，原来这个是用的 <code>Spring Context</code>。下载源码，看下官方类的说明写的啥，如图9：</p> <p><img src="/assets/img/ruoyi/2/9.jpg" alt="code"></p> <p>原文如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Implementation of {@link java.util.Map} for use when building model data for use
 * with UI tools. Supports chained calls and generation of model attribute names.
 *
 * &lt;p&gt;This class serves as generic model holder for Servlet MVC but is not tied to it.
 * Check out the {@link Model} interface for an interface variant.
 *
 * @author Rob Harrop
 * @author Juergen Hoeller
 * @since 2.0
 * @see Conventions#getVariableName
 * @see org.springframework.web.servlet.ModelAndView
 */</span>
</code></pre></div><p>可以看到，意思是 <code>ModelMap</code> 是标准库中 <code>Map</code> 的一个实现，用于使用 UI 工具构造 model 数据。也就是说这个是结合 html 网页的模型数据传输所使用的。</p> <p>我们再看 <code>POST /login</code>函数，如图：</p> <p><img src="/assets/img/ruoyi/2/10.jpg" alt="method"></p> <p>函数有三个参数 <code>String username</code>、<code>String password</code> 和 <code>Boolean rememberMe</code>，分别对应的是：用户名、用户密码和是否记住我。并没有验证码相关的参数。是否说明验证码没有通过后台校验，或者它在哪里被校验的呢？</p> <p>我们试验一下。</p> <p>第一步，我们先故意输错验证码登录，然后观察响应体，再通过响应体的关键数据搜索代码中的实现。</p> <p>验证码错误时，响应体如图：</p> <p><img src="/assets/img/ruoyi/2/11.jpg" alt="body"></p> <p>我们可以看到关键报错信息为“验证码错误”，通过这几个汉字我们找到定义，如图：</p> <p><img src="/assets/img/ruoyi/2/12.jpg" alt="error"></p> <p>然后我们搜索对应的常量定义，找到使用处，如图：</p> <p><img src="/assets/img/ruoyi/2/13.jpg" alt="code"></p> <p>图中，我们就可以看到判断代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ShiroConstants</span><span class="token punctuation">.</span><span class="token constant">CAPTCHA_ERROR</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">ShiroConstants</span><span class="token punctuation">.</span><span class="token constant">CURRENT_CAPTCHA</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这里判定的是如果 request 的 attribute 里 键值为 <code>captcha</code>（对应常量为 <code>CURRENT_CAPTCHA</code>）的值，是否为 <code>captchaError</code>（常量为 <code>CAPTCHA_ERROR</code>）。如果是，则说明验证码有问题。</p> <p>看一下此方法被调用的地方，如图：</p> <p><img src="/assets/img/ruoyi/2/14.jpg" alt="call"></p> <p>证明确实是登录才判断的验证码是否校验通过。那么 <code>captcha</code> 是在什么时候被设置的值呢？我们再搜索一下它的常量定义。</p> <p>然后我们找到了类 <code>CaptchaValidateFilter</code>，然后看到了实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">onAccessDenied</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span>
<span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">ShiroConstants</span><span class="token punctuation">.</span><span class="token constant">CURRENT_CAPTCHA</span><span class="token punctuation">,</span> <span class="token class-name">ShiroConstants</span><span class="token punctuation">.</span><span class="token constant">CAPTCHA_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再观察，发现此类是继承自 Shiro 的 <code>AccessControlFilter</code>，用于验证码校验的过滤器。</p> <p>然后我们查找校验代码，发现如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validateResponse</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">String</span> validateCode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token class-name">ShiroUtils</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">KAPTCHA_SESSION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 验证码清除，防止多次使用。</span>
    request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">KAPTCHA_SESSION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>validateCode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>validateCode<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们可以看到，对验证码的判断，原始数据是从 attribute 里获取的，键值对应的常量为 <code>KAPTCHA_SESSION_KEY</code>，我们再查找一下它生成的地方，找到类 <code>SysCaptchaController</code>，然后看到代码如图：</p> <p><img src="/assets/img/ruoyi/2/15.jpg" alt="controller"></p> <p>可以看到该函数对应的 API 为 <code>/captchaImage</code>，正好就是界面上生成验证码图片所调用的 API。我们观察一下此 API。哎……</p> <p>代码中使用了大量明文字符串，而非常量字符串，非常……非常……难受。但凡有一点代码洁癖的，还是最好把这些常见的字符串定义为常量，或者使用工具组件中已定义好的枚举、常量。要不然别人会说你的代码写得好土。</p> <p>我们可以看到此处验证码为数学模式式时，生成校验码的方法为 <code>String capText = captchaProducerMath.createText();</code>，然后后面的代码会将代码分割为公式部分和结果部分，公式部分生成图片响应前端，结果部分存储到 attribute 中用于判断是否正确。</p> <p>以上代码分析后，整个验证码的生成和比较就比较清晰了。整理如下：
1.用户未登录状态，调用 <code>/captchaImage</code>，生成验证码图片，并将验证码正确结果放入 request 的 attribute 中，键值为 <code>KAPTCHA_SESSION_KEY</code>
2.用户点击登录，调用 <code>/login</code> 传递数据，包括用户名、密码、验证码、是否记住用户
3.拦截器 <code>CaptchaValidateFilter</code> 会先读取 <code>/login</code> 传入的验证码，并与 attribute 中的 <code>KAPTCHA_SESSION_KEY</code> 进行比较，如果相同，验证码正确，否则验证码错误，并同时清理已记录的 attribute <code>KAPTCHA_SESSION_KEY</code>；然后会在 attribute 中添加一个头 <code>captcha</code>，用于记录验证码校验结果
4.<code>/loign</code> 对应的方法会调用登录代码 <code>subject.login(token);</code>,会触发 <code>UserRealm</code> 中的认证方法 <code>doGetAuthenticationInfo()</code>，会调用 <code>SysLoginService</code> 的方法 <code>login(String username, String password)</code> 进行用户认证，而其中就会先进行验证码的判定
5.从 attribute 里读取验证码校验结果的键值 <code>captcha</code>，如果对应的值为 <code>captchaError</code>，则说明验证码不对，就不会再进行用户名、密码的判断了</p> <p>我们最开始有疑问的验证码校验，到此得到了答案。</p> <h2 id="奇怪的逻辑"><a href="#奇怪的逻辑" class="header-anchor">#</a> 奇怪的逻辑</h2> <p>从上面我们知道，其实最终对用户认证相关信息的判断都落在 <code>UserRealm</code>，这是 Shiro 框架中认证相关的类，暂不详细展开，在这个类里面，各种认证情况都以异常形式抛出，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span>
<span class="token punctuation">{</span>
    user <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CaptchaException</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UserNotExistsException</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnknownAccountException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UserPasswordNotMatchException</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncorrectCredentialsException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UserPasswordRetryLimitExceedException</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExcessiveAttemptsException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UserBlockedException</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockedAccountException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RoleBlockedException</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockedAccountException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;对用户[&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot;]进行登录验证..验证未通过{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是最奇怪的是，RuoYi 的作者在 <code>login()</code> 方法中针对各种认证失败的情况抛出了各种异常，然后又在 <code>UserRealm</code> 捕获这些异常后，再抛出其他的异常，最后又依据这些异常共同的父类来决定响应的错误数据。</p> <p>这就像给一个孩子穿了件红色外套，然后走到门外，又给孩子加了件绿色外套，最后判断孩子的情况，又是通过外套是毛衣来判断。真让人摸不着头脑。</p> <p>一般情况下，我们有两种实现策略。第一种，针对没的认证失败情况，以不同的异常抛出，那么就会有一个处理异常的顶层设计，通过不同的异常，返回不同的响应信息，在 Spring Boot 框架中，这个异常处理的顶层设计就是 <code>@ControllerAdvice</code>，所有异常都可以在这里处理。</p> <p>第二种，我们直接在 <code>Controller</code> 中捕获异常，直接返回不同的响应信息即可。</p> <p>像 RuoYi 作者这种，把以上两种情况结合起来，又在中间多包装一层异常的设计，就显得既臃肿又复杂，不可取。</p> <h2 id="原材料从哪里来"><a href="#原材料从哪里来" class="header-anchor">#</a> 原材料从哪里来</h2> <p>在验证码探秘的过程中，我们也基本理清了登录的逻辑，但我们还没有看到用户和密码是如何校验的，我们在上面逻辑中找一下相关逻辑。</p> <p>我们先在 <code>SysLoginService</code> 中的 <code>login()</code> 中看到以下代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 密码如果不在指定范围内 错误</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>password<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">UserConstants</span><span class="token punctuation">.</span><span class="token constant">PASSWORD_MIN_LENGTH</span>
    <span class="token operator">||</span> password<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">UserConstants</span><span class="token punctuation">.</span><span class="token constant">PASSWORD_MAX_LENGTH</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_FAIL</span><span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.password.not.match&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserPasswordNotMatchException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 用户名不在指定范围内 错误</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">UserConstants</span><span class="token punctuation">.</span><span class="token constant">USERNAME_MIN_LENGTH</span>
    <span class="token operator">||</span> username<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">UserConstants</span><span class="token punctuation">.</span><span class="token constant">USERNAME_MAX_LENGTH</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_FAIL</span><span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.password.not.match&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserPasswordNotMatchException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码，判断了密码长度，不在长度范围内的密码，直接判定无效。但一般情况下，密码相关的复杂度判断，我们一般会采用密码策略的设计，提供一个用户可配置的策略，其中就会有密码长度的配置项。然后在这种判断密码长度时，读取密码长度配置项，再进行判断即可。用户名也类似的逻辑。</p> <p>像作者这种直接将逻辑写死的情况，灵活性非常差，后期如果用户想自定义密码长度时，又需要修改代码，不建议像 RuoYi 作者这样实现。</p> <p>接着，代码查询用户信息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 查询用户信息</span>
<span class="token class-name">SysUser</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">selectUserByLoginName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后对用户的可用性状态判断，接着进行了密码校验，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>passwordService<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>跟踪到这个实现里，忽略其他逻辑，发现密码校验函数为 <code>matches(SysUser user, String newPassword)</code>，其实现为如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token function">encryptPassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getLoginName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newPassword<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这段代码，可以明确的看出来就是将登录的数据，加盐后，再加密，然后与记录中的用户密码数据进行比较。我们再看一下 <code>encryptPassword</code> 的实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Md5Hash</span><span class="token punctuation">(</span>loginName <span class="token operator">+</span> password <span class="token operator">+</span> salt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也就是存储的密码数据不是加密数据，而是用户名加上密码再加上盐，最后用 <code>MD5</code> 得到哈希值。并且我们也知道，用户创建时，存储的数据中，除了基本的用户名、用户密码等信息，还包括给用户的盐值。</p> <p>我们大概找一下这个盐值的生成方式，代码如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/**
 * 生成随机盐
 */
public static String <span class="token function-name function">randomSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    // 一个Byte占两个字节，此处生成的3字节，字符串长度为6
    SecureRandomNumberGenerator secureRandom <span class="token operator">=</span> new SecureRandomNumberGenerator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String hex <span class="token operator">=</span> secureRandom.nextBytes<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>.toHex<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">return</span> hex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>本篇分析了用户的基本登录流程，了解到 RuoYi 作者没有考虑密码传输的安全性，对异常的处理不是很清爽，也知道了作者没有设计密码策略相关配置，相关的配置非常不灵活。而且可以复用的的字符串也应该抽离为常量，这些在我们做项目时都应该尽量避免。</p> <p>另外，我们也看到，作者对用户密码的存储，使用了比较安全的算法，不仅加了盐，还使用 <code>MD5</code> 进行哈希，这点可以提升安全性，值得学习。</p> <p>下一篇，我们会继续再展开一些关于 Shiro 框架认证相关的逻辑。本篇就到这里，比心，❤。</p></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      发布时间 : 2022-10-28
    </span> <!----></section> <section class="post-links" data-v-4e23451f><a href="/posts/2022/10/19/ruoyi-1.html" class="post-link" data-v-4e23451f>
      上一篇 : 最火后台管理系统 RuoYi 项目探秘，之一
    </a> <a href="/posts/2022/11/12/ruoyi-3.html" class="post-link" data-v-4e23451f>
      下一篇 : 最火后台管理系统 RuoYi 项目探秘，之三
    </a></section></section> <!----></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" data-v-9d847660><img src="https://images.bookhub.tech/mp/avatar.jpg" alt="阿呜" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      阿呜
    </section> <section class="info-desc" data-v-9d847660>‍📢云原生框架 Micronaut 推广者<br/>☁️云计算从业者<br/>🌱高级软件工程师<br/>☘️系统架构师<br/>💻个人空间：<a href="https://luansheng.fun">https://luansheng.fun</a><br/>📱公众号：程序员爱读书</br><img src="https://images.bookhub.tech/mp/mp.png" width="60%"/></section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="中国·成都" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>中国·成都</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          中国·成都
        </span></span></section> <section data-v-9d847660><span title="MortNon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>MortNon</title><use xlink:href="#icon-organization" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          MortNon
        </span></span></section> <section data-v-9d847660><a href="mailto:mortnon@outlook.com" title="mortnon@outlook.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>mortnon@outlook.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          mortnon@outlook.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-9d847660><section class="info-sns clearfix" data-v-9d847660><a href="https://github.com/dev2007" target="_blank" class="sns-link" data-v-9d847660><span title="GitHub: dev2007" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitHub: dev2007</title><use xlink:href="#icon-github" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://juejin.cn/user/2620868693599405" target="_blank" class="sns-link" data-v-9d847660><span title="掘金: dev2007" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>掘金: dev2007</title><use xlink:href="#icon-juejin" data-v-9d847660 data-v-9d847660></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>文章目录</span> <div class="post-nav-toc"><ul><li><a href="/posts/2022/10/28/ruoyi-2.html#常见又不常见的登录">常见又不常见的登录</a></li><li><a href="/posts/2022/10/28/ruoyi-2.html#神秘的验证码">神秘的验证码</a></li><li><a href="/posts/2022/10/28/ruoyi-2.html#奇怪的逻辑">奇怪的逻辑</a></li><li><a href="/posts/2022/10/28/ruoyi-2.html#原材料从哪里来">原材料从哪里来</a></li><li><a href="/posts/2022/10/28/ruoyi-2.html#小结">小结</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-1375e54c><p class="footer-sns-links" data-v-1375e54c><a href="https://github.com/dev2007" target="_blank" class="sns-link" data-v-1375e54c><span title="GitHub: dev2007" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitHub: dev2007</title><use xlink:href="#icon-github" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://juejin.cn/user/2620868693599405" target="_blank" class="sns-link" data-v-1375e54c><span title="掘金: dev2007" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>掘金: dev2007</title><use xlink:href="#icon-juejin" data-v-1375e54c data-v-1375e54c></use></svg></span></a></p> <!----> <p class="footer-text" data-v-1375e54c><div style="display:flex;flex-direction:column"><span>&copy; 2022~2024 阿呜</span>
        <div style="display:flex;flex-direction:row;justify-content:center">
        <a href="https://beian.miit.gov.cn" target="_blank" style="color: rgb(102, 102, 102);" onmouseover="this.style.color='rgb(30, 144, 255)'" onmouseout="this.style.color='rgb(102,102,102)'">蜀ICP备2024097210号</a>
        <div style="display:flex;align-items:center;margin-left:8px">
        <img src="logo01.png" style="width:16px;height:16px">
        <a href="https://beian.mps.gov.cn/#/query/webSearch?code=51018002000252" target="_blank" style="color: rgb(102, 102, 102);" onmouseover="this.style.color='rgb(30, 144, 255)'" onmouseout="this.style.color='rgb(102,102,102)'">川公网安备51018002000252号</a>
        </div>
        </div></div></p></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.467e2829.js" defer></script><script src="/assets/js/7.4e539d82.js" defer></script><script src="/assets/js/58.69071d3d.js" defer></script>
  </body>
</html>
