(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{425:function(v,_,e){"use strict";e.r(_);var r=e(1),t=Object(r.a)({},(function(){var v=this,_=v._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[_("p",[v._v("本文翻译自 "),_("a",{attrs:{href:"https://datamify.com/architecture/how-to-understand-event-sourcing-in-microservices-architecture/",target:"_blank",rel:"noopener noreferrer"}},[v._v("How To Understand Event Sourcing In Microservices Architecture"),_("OutboundLink")],1),v._v("，作者 "),_("a",{attrs:{href:"https://datamify.com/author/vader/",target:"_blank",rel:"noopener noreferrer"}},[v._v("OLEKSII"),_("OutboundLink")],1),v._v("。")]),v._v(" "),_("h2",{attrs:{id:"问题描述"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#问题描述"}},[v._v("#")]),v._v(" 问题描述")]),v._v(" "),_("p",[_("code",[v._v("CQRS")]),v._v(" 模型的局限性实际在于只保存领域实体的最新状态。对于某些应用程序，这已经足够了。然而，其他系统需要更大的弹性。这可以通过"),_("code",[v._v("事件溯源（Event Sourcing）")]),v._v("实现。")]),v._v(" "),_("h2",{attrs:{id:"事件溯源"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#事件溯源"}},[v._v("#")]),v._v(" 事件溯源")]),v._v(" "),_("p",[_("code",[v._v("事件溯源")]),v._v("可以描述为一组以下的原则。")]),v._v(" "),_("ul",[_("li",[_("code",[v._v("事件溯源")]),v._v("通常与 "),_("code",[v._v("CQRS")]),v._v(" 结合使用。")]),v._v(" "),_("li",[v._v("实体的所有更新操作都表现为命令。通常，这些命令与领域区域相关，对业务也有一定意义。")]),v._v(" "),_("li",[v._v("每个命令都保存到追加事件日志中。因此，命令是不可变更的。这使审计功能开箱即用。")]),v._v(" "),_("li",[v._v("服务订阅到事件日志，是为了处理事件并能提供一些业务价值。")])]),v._v(" "),_("h3",{attrs:{id:"事件溯源示例"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#事件溯源示例"}},[v._v("#")]),v._v(" 事件溯源示例")]),v._v(" "),_("p",[v._v("让我们回顾一个例子。")]),v._v(" "),_("p",[_("img",{attrs:{src:"/assets/img/EventSourcingInitial.jpg",alt:"EventSourcingInitial"}})]),v._v(" "),_("p",[v._v("这是一个 "),_("code",[v._v("CQRS")]),v._v(" 模型（详情参阅文章 "),_("a",{attrs:{href:"/posts/2022/10/10/microservice-cqrs"}},[v._v("如何理解微服务体系结构中的 CQRS")]),v._v("）。")]),v._v(" "),_("p",[v._v("假设我们只对电影评分功能感兴趣。用户以评分的形式（例如从 0 到 10）留下对电影的意见。这样：")]),v._v(" "),_("ul",[_("li",[v._v("用户在 "),_("em",[v._v("Movie Actions Service")]),v._v(" 上启动"),_("strong",[v._v("添加评分")]),v._v("命令。")]),v._v(" "),_("li",[_("em",[v._v("Movie Actions Service")]),v._v(" 找到指定的电影。它可以包含许多字段。然而，我们只对计算评分的字段感兴趣："),_("em",[v._v("电影投票总数")]),v._v("和"),_("em",[v._v("所有电影投票总数")]),v._v("。")]),v._v(" "),_("li",[v._v("评分信息已更新。一个被添加到"),_("em",[v._v("电影投票总数")]),v._v("中。来自"),_("strong",[v._v("添加评分")]),v._v("命令的新评分将添加到"),_("em",[v._v("所有电影投票总数")]),v._v("中。")]),v._v(" "),_("li",[v._v("完整的电影快照被发送到 "),_("em",[v._v("Message Broker")]),v._v("。")]),v._v(" "),_("li",[v._v("所有用户都可以通过 "),_("em",[v._v("Movie Summary Service")]),v._v(" 查看更新的电影评分（"),_("em",[v._v("所有电影投票总数")]),v._v("除以"),_("em",[v._v("电影投票总数")]),v._v("）。")])]),v._v(" "),_("p",[v._v("这种设计的问题在于，只保存了最新的评分状态。整个历史已经丢失了。")]),v._v(" "),_("p",[v._v("让我们回顾一个"),_("code",[v._v("事件溯源")]),v._v("模型。")]),v._v(" "),_("p",[_("img",{attrs:{src:"/assets/img/EventSourcing.jpg",alt:"EventSourcing"}})]),v._v(" "),_("p",[v._v("此图几乎与上一个图一样。"),_("code",[v._v("CQRS")]),v._v(" 模型也可以用在这里。")]),v._v(" "),_("ul",[_("li",[v._v("用户在 "),_("em",[v._v("Movie Actions Service")]),v._v(" 上启动"),_("strong",[v._v("添加评分")]),v._v("命令。")]),v._v(" "),_("li",[v._v("事件还有以下信息：向电影《指环王》"),_("strong",[v._v("添加评分")]),v._v(" 8。")]),v._v(" "),_("li",[_("em",[v._v("Movie Actions Service")]),v._v(" 将此事件保存到"),_("em",[v._v("事件日志")]),v._v("中（例如 "),_("a",{attrs:{href:"https://kafka.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[v._v("Kafka"),_("OutboundLink")],1),v._v("）。")]),v._v(" "),_("li",[_("em",[v._v("Movie Summary Service")]),v._v(" 以前使用了其数据库中每部电影的"),_("em",[v._v("电影投票总数")]),v._v("和"),_("em",[v._v("所有电影投票总数")]),v._v("字段。")]),v._v(" "),_("li",[_("em",[v._v("Movie Summary Service")]),v._v(" 处理事件日志中的记录并更新评分。")]),v._v(" "),_("li",[v._v("所有用户都可以看到更新的电影评分（"),_("em",[v._v("所有电影投票总数")]),v._v("除以"),_("em",[v._v("电影投票总数")]),v._v("）。")])]),v._v(" "),_("p",[v._v("乍一看，一切都没有改变。然而，它给系统带来了更多的弹性。")]),v._v(" "),_("p",[v._v("电影评分的问题在于人们有不同的口味。一般评分值（如 7.35）仅显示基于多人意见计算的平均分数。作为一家提供电影流媒体功能的公司，我们有意为用户提供良好的建议。我们如何才能做到这一点？为了简化逻辑，我们可以用一条语句来完成。推荐那些与该用户高度评价的电影类型相似的电影。")]),v._v(" "),_("p",[v._v("这样，引入了一种新的服务——"),_("em",[v._v("Movie Recommendation Service")]),v._v("。")]),v._v(" "),_("p",[_("img",{attrs:{src:"/assets/img/EventSourcingFinal.jpg",alt:"EventSourcingFinal"}})]),v._v(" "),_("p",[v._v("我们正在扩展现有系统。因此，"),_("em",[v._v("Movie Recommendation Service")]),v._v(" 应该处理所有以前分配的评分。通过事件溯源，这是可能的，因为我们将此信息保存在 "),_("a",{attrs:{href:"https://kafka.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[v._v("Kafka"),_("OutboundLink")],1),v._v(" 中（电影《指环王》"),_("strong",[v._v("添加评分")]),v._v(" 8）。在第一个示例中，由于我们只存储了最后一个电影评分值，因此做不到。")]),v._v(" "),_("h3",{attrs:{id:"事件溯源的优势"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#事件溯源的优势"}},[v._v("#")]),v._v(" 事件溯源的优势")]),v._v(" "),_("ul",[_("li",[v._v("关注点的分离。")]),v._v(" "),_("li",[v._v("每个服务的缩放都是独立的。")]),v._v(" "),_("li",[v._v("可以为每个服务选择合适的数据存储及其模式（schema）。")]),v._v(" "),_("li",[v._v("所有服务中的简单高效的查询。")]),v._v(" "),_("li",[v._v("新服务可以轻松添加到现有应用程序中。")])]),v._v(" "),_("h3",{attrs:{id:"事件溯源的劣势"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#事件溯源的劣势"}},[v._v("#")]),v._v(" 事件溯源的劣势")]),v._v(" "),_("ul",[_("li",[v._v("复杂性。")]),v._v(" "),_("li",[v._v("最终一致性。")]),v._v(" "),_("li",[v._v("新服务可能需要大量时间来处理已有事件。")])]),v._v(" "),_("h2",{attrs:{id:"总结"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[v._v("#")]),v._v(" 总结")]),v._v(" "),_("p",[v._v("在本文中，我们回顾了"),_("code",[v._v("事件溯源")]),v._v("模式。它通常与 "),_("code",[v._v("CQRS")]),v._v(" 搭配使用。值得一提的是，这种模式的必要性可能发生在复杂的系统中。因此，应谨慎选择，以免给系统带来不必要的复杂性。")])])}),[],!1,null,null,null);_.default=t.exports}}]);